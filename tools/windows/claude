#!/bin/bash
# Claude Desktop CLI - Control Claude Desktop from WSL
# Usage: claude <command> [args]
#
# Commands:
#   status          Check if Claude Desktop is running
#   info            Get conversation info (ID, URL, title) - requires DevTools
#   send <message>  Send a message to Claude Desktop
#   read            Read the current conversation
#   messages        Get structured messages with roles - requires DevTools
#   last            Get the last assistant response
#   watch [interval] Watch for new responses continuously
#
# DevTools mode (more precise):
#   Launch Claude Desktop with: --remote-debugging-port=9222 --remote-allow-origins=*
#   Then info/messages commands will use DevTools Protocol for precise access
#
# Examples:
#   claude status
#   claude info          # Get conversation ID
#   claude send "Hello"
#   claude last
#   claude messages      # Structured JSON with roles

WINDOWS_PYTHON="/mnt/c/ProgramData/Anaconda3/python.exe"
PYAUTOGUI_SCRIPT="C:\\Users\\din18\\claude_desktop_api.py"
DEVTOOLS_SCRIPT="C:\\Users\\din18\\claude_devtools_api.py"

if [ -z "$1" ]; then
    echo "Claude Desktop CLI"
    echo ""
    echo "Usage: claude <command> [args]"
    echo ""
    echo "Commands:"
    echo "  status          Check if running"
    echo "  info            Conversation info (DevTools)"
    echo "  send <message>  Send a message"
    echo "  read            Read full conversation"
    echo "  messages        Structured messages (DevTools)"
    echo "  last            Get last response"
    echo "  watch [sec]     Watch for changes"
    echo ""
    echo "For DevTools mode, launch Claude with:"
    echo "  --remote-debugging-port=9222 --remote-allow-origins=*"
    exit 1
fi

COMMAND="$1"
shift

# Try DevTools first for most commands, fall back to pyautogui
case "$COMMAND" in
    info|messages)
        # DevTools only
        "$WINDOWS_PYTHON" "$DEVTOOLS_SCRIPT" "$COMMAND" "$@"
        ;;
    send|last)
        # Prefer DevTools, fall back to pyautogui
        result=$("$WINDOWS_PYTHON" "$DEVTOOLS_SCRIPT" "$COMMAND" "$@" 2>/dev/null)
        if [ -n "$result" ] && [ "$result" != "None" ] && [ "$result" != "null" ]; then
            echo "$result"
        else
            "$WINDOWS_PYTHON" "$PYAUTOGUI_SCRIPT" "$COMMAND" "$@"
        fi
        ;;
    *)
        # pyautogui for status, read, watch
        "$WINDOWS_PYTHON" "$PYAUTOGUI_SCRIPT" "$COMMAND" "$@"
        ;;
esac
